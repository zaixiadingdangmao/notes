- [å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°](#å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°)
  - [1. å“åº”å¼æ•°æ®äºå‰¯ä½œç”¨å‡½æ•°](#1-å“åº”å¼æ•°æ®äºå‰¯ä½œç”¨å‡½æ•°)
  - [2. å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°](#2-å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°)
  - [3. è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”ç³»ç»Ÿ](#3-è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”ç³»ç»Ÿ)
  - [4. åˆ†æ”¯åˆ‡æ¢ä¸ cleanup](#4-åˆ†æ”¯åˆ‡æ¢ä¸-cleanup)
  - [5. åµŒå¥—çš„ effect ä¸ effect æ ˆ](#5-åµŒå¥—çš„-effect-ä¸-effect-æ ˆ)
  - [6. é¿å…æ— é™é€’å½’å¾ªç¯](#6-é¿å…æ— é™é€’å½’å¾ªç¯)
  - [7. è°ƒåº¦æ‰§è¡Œ](#7-è°ƒåº¦æ‰§è¡Œ)
  - [8. è®¡ç®—å±æ€§ computed ä¸ lazy](#8-è®¡ç®—å±æ€§-computed-ä¸-lazy)
  - [9. watch åŸç†](#9-watch-åŸç†)
  - [10. ç«‹åˆ»æ‰§è¡Œçš„ watch ä¸å›è°ƒæ‰§è¡Œæ—¶æœº](#10-ç«‹åˆ»æ‰§è¡Œçš„-watch-ä¸å›è°ƒæ‰§è¡Œæ—¶æœº)
  - [11. è¿‡æœŸå‰¯ä½œç”¨](#11-è¿‡æœŸå‰¯ä½œç”¨)

## å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°

å“åº”ç³»ç»Ÿæ˜¯ Vue.js çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼ŒVue3 é‡‡ç”¨ Proxy å®ç°å“åº”å¼æ•°æ®

### 1. å“åº”å¼æ•°æ®äºå‰¯ä½œç”¨å‡½æ•°

å‰¯ä½œç”¨å‡½æ•°æŒ‡çš„æ˜¯ä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„å‡½æ•°ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
function effect() {
  document.body.innerHTML = 'hello vue3';
}
```

æˆ‘ç®€å•ç†è§£ä¸ºå½±å“åˆ°å…¶ä»–å‡½æ•°æˆ–å˜é‡ï¼Œé€ æˆäº†æŸä¸€ç§ç»“æœçš„å‡½æ•°ã€ç§°ä¸ºå‰¯ä½œç”¨å‡½æ•°

**å“åº”å¼æ•°æ®**å°±æ˜¯ä¿®æ”¹äº†æŸä¸ªå­—æ®µåï¼Œè‡ªåŠ¨æ‰§è¡Œå’Œå®ƒç›¸å…³çš„å‰¯ä½œç”¨å‡½æ•°ï¼š

```js
const obj = { text: 'hello vue3' };
function effect() {
  document.body.innerHTML = obj.text;
}
// obj.text ä¿®æ”¹æ—¶ è‡ªåŠ¨æ‰§è¡Œ effect å‡½æ•°
```

### 2. å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°

ä¸¤ç‚¹çº¿ç´¢

- å½“å‰¯ä½œç”¨å‡½æ•° `effect` æ‰§è¡Œæ—¶ï¼Œä¼šè§¦å‘ `obj.text` çš„**è¯»å–**æ“ä½œ
- å½“ä¿®æ”¹ `obj.text` çš„å€¼æ—¶ï¼Œä¼šè§¦å‘å­—æ®µ `obj.text` çš„**è®¾ç½®**æ“ä½œ

åˆæ­¥æ˜¯å®ç°ï¼š

```js
const bucket = new Set();

const data = { text: '' };

const obj = new Proxy(data, {
  get(target, key) {
    bucket.add(effect);
    return target[key];
  },

  set(target, key, newValue) {
    target[key] = newValue;
    bucket.forEach(fn => fn());

    return true;
  }
});

function effect() {
  document.body.innerHTML = obj.text;
}

effect();

setTimeout(() => {
  obj.text = 'hello vue3';
}, 1000);
```

### 3. è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”ç³»ç»Ÿ

ä¸€ä¸ªå“åº”å¼ç³»ç»Ÿçš„å·¥ä½œæµç¨‹ï¼š

- å½“**è¯»å–**æ“ä½œå‘ç”Ÿæ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ°â€œæ¡¶â€ä¸­
- å½“**è®¾ç½®**æ“ä½œå‘ç”Ÿæ—¶ï¼Œä»â€œæ¡¶â€ä¸­å–å‡ºå‰¯ä½œç”¨å‡½æ•°å¹¶æ‰§è¡Œ

ä¸Šé¢ä»£ç ä¸­ï¼Œå‰¯ä½œç”¨å‡½æ•°åç§°ä¸º **effect** ï¼Œå¦‚æœä¿®æ”¹å‰¯ä½œç”¨å‡½æ•°åç§°ï¼Œä»£ç å°†ä¸èƒ½æ­£å¸¸æ‰§è¡Œ

ä¼˜åŒ–ä¸€ä¸‹ä»¥ä¸Šä»£ç ï¼Œæä¾›ä¸€ç§ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°çš„æœºåˆ¶ï¼š

```js
const bucket = new Set();
const data = { text: '' };

const obj = new Proxy(data, {
  get(target, key) {
    // å°† activeEffect æ·»åŠ åˆ°â€œæ¡¶â€ä¸­
    if (activeEffect) {
      bucket.add(activeEffect);
    }
    return target[key];
  },

  set(target, key, newValue) {
    target[key] = newValue;
    bucket.forEach(fn => fn());

    return true;
  }
});

// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜æ”¾è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
let activeEffect;

// effect ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
function effect(fn) {
  // ä¿å­˜å‰¯ä½œç”¨å‡½æ•°
  activeEffect = fn;
  fn();
}

effect(() => {
  document.body.innerHTML = obj.text;
});

setTimeout(() => {
  obj.text = 'hello vue3';
}, 1000);
```

ä¼˜åŒ–åçš„ä»£ç **æ²¡æœ‰åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸è¢«æ“ä½œçš„ç›®æ ‡å­—æ®µä¹‹é—´å»ºç«‹æ˜ç¡®çš„è”ç³»**ï¼Œæ— è®ºè¯»å–å“ªä¸€ä¸ªå±æ€§ï¼Œå…¶å®éƒ½ä¸€æ ·ï¼Œéƒ½ä¼šæŠŠå‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ°â€œæ¡¶â€ä¸­ï¼›å½“è®¾ç½®çš„å±æ€§æ—¶ï¼Œæ— è®ºè®¾ç½®å“ªä¸€ä¸ªå±æ€§ï¼Œä¹Ÿéƒ½ä¼šæŠŠâ€œæ¡¶â€é‡Œçš„å‰¯ä½œç”¨å‡½æ•°å–å‡ºå¹¶æ‰§è¡Œ

ç†æƒ³å…³ç³»å›¾å¦‚ä¸‹ï¼š
![Snipaste_2022-08-07_11-55-00](https://gcore.jsdelivr.net/gh/zaixiadingdangmao/imageStore/Snipaste_2022-08-07_11-55-00.png)

ä¿®æ”¹ä»¥ä¸Šä»£ç ï¼Œé‡‡ç”¨ WeakMap æ¥ä»£æ›¿ Set ä½œä¸ºæ¡¶çš„æ•°æ®ç»“æ„ï¼š

```js
const bucket = new WeakMap();
const data = { text1: '', text2: '' };

const obj = new Proxy(data, {
  get(target, key) {
    if (!activeEffect) return;

    // æ ¹æ® target ä»â€œæ¡¶â€ä¸­å–çš„ depsMapï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ª Map ç±»å‹ï¼š key --> effects
    let depsMap = bucket.get(target);
    if (!depsMap) {
      bucket.set(target, (depsMap = new Map()));
    }

    // å†æ ¹æ® key ä» depsMap ä¸­å–å¾— depsï¼Œå®ƒæ˜¯ä¸€ä¸ª Set ç±»å‹
    let deps = depsMap.get(key);
    if (!deps) {
      depsMap.set(key, (deps = new Set()));
    }

    // æœ€åå°†å½“å‰æ¿€æ´»çš„å‡½æ•°æ·»åŠ åˆ°â€œæ¡¶â€ä¸­
    deps.add(activeEffect);

    return target[key];
  },

  set(target, key, newValue) {
    // è®¾ç½®å±æ€§
    target[key] = newValue;

    const depsMap = bucket.get(target);
    if (!depsMap) return;

    const effects = depsMap.get(key);

    effects && effects.forEach(fn => fn());

    return true;
  }
});

// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜æ”¾è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
let activeEffect;

// effect ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
function effect(fn) {
  // ä¿å­˜å‰¯ä½œç”¨å‡½æ•°
  activeEffect = fn;
  fn();
  // activeEffect = null;
}

effect(() => {
  console.log('ğŸš©  -> file: index.html -> line 99 -> ', 'run -> text1');
  document.querySelector('#div1').innerHTML = obj.text1;
});

setTimeout(() => {
  obj.text2 = 'div 2';
}, 1000);
```

å°è£…ä¸€ä¸‹ trackï¼ˆè¿½è¸ªï¼‰ å‡½æ•° å’Œ triggerï¼ˆè§¦å‘ï¼‰ å‡½æ•°

```js
// åœ¨ get å†…éƒ¨è·Ÿè¸ªå˜åŒ–
function track(target, key) {
  if (!activeEffect) return;

  // æ ¹æ® target ä»â€œæ¡¶â€ä¸­å–çš„ depsMapï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ª Map ç±»å‹ï¼š key --> effects
  let depsMap = bucket.get(target);
  if (!depsMap) {
    bucket.set(target, (depsMap = new Map()));
  }

  // å†æ ¹æ® key ä» depsMap ä¸­å–å¾— depsï¼Œå®ƒæ˜¯ä¸€ä¸ª Set ç±»å‹
  let deps = depsMap.get(key);
  if (!deps) {
    depsMap.set(key, (deps = new Set()));
  }

  // æœ€åå°†å½“å‰æ¿€æ´»çš„å‡½æ•°æ·»åŠ åˆ°â€œæ¡¶â€ä¸­
  deps.add(activeEffect);
}
```

```js
// åœ¨ set å†…éƒ¨è§¦å‘å˜åŒ–
function trigger(target, key) {
  const depsMap = bucket.get(target);
  if (!depsMap) return;

  const effects = depsMap.get(key);

  effects && effects.forEach(fn => fn());
}
```

### 4. åˆ†æ”¯åˆ‡æ¢ä¸ cleanup

```js
const data = { ok: true, text: 'hellow world' };
const obj = new Proxy(data, {
  /*...*/
});

effect(() => {
  document.body.innerHTML = obj.ok ? obj.text : 'not';
});
```

åœ¨ effect å‡½æ•°å†…éƒ¨æœ‰ä¸€ä¸ªä¸‰å…ƒè¡¨è¾¾å¼ï¼Œæ ¹æ® `obj.ok` å€¼çš„ä¸åŒä¼šæ‰§è¡Œä¸åŒçš„ä»£ç åˆ†æ”¯ï¼Œå½“ `obj.ok` çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä»£ç æ‰§è¡Œçš„åˆ†æ”¯ä¹Ÿä¼šæ›´æ–°ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„åˆ†æ”¯åˆ‡æ¢

å½“ `obj.ok` ä¸º `true` æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç›‘å¬ï¼Œ`obj.text`ï¼Œå½“ æˆ‘ä»¬å°±ä¿®æ”¹ `obj.ok` çš„ ä¸º `false` å¹¶è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œä¹‹åï¼Œè¿˜æ˜¯ä¼šå­˜åœ¨ç›‘å¬ `obj.text` çš„é—®é¢˜ï¼Œè¿™å°±æ˜¯é—ç•™çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œé—ç•™çš„å‰¯ä½œç”¨å‡½æ•°ä¼šå¯¼è‡´ä¸å¿…è¦çš„æ›´æ–°

è§£å†³è¿™ä¸ªé—®é¢˜çš„æ€è·¯å°±æ˜¯ï¼šæ¯æ¬¡å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæŠŠå®ƒä»æ‰€æœ‰ä¸ä¹‹å…³è”çš„ä¾èµ–é›†åˆä¸­åˆ é™¤ï¼Œå½“å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œä¼šé‡æ–°å»ºç«‹è”ç³»ï¼Œä½†åœ¨æ–°çš„å…³è”ä¸­ä¸ä¼šåŒ…å«é—ç•™çš„å‰¯ä½œç”¨å‡½æ•°

åœ¨ effect å†…éƒ¨å¢åŠ ä¸€ä¸ª effectFn å‡½æ•°ï¼Œå¹¶ä¸ºå…¶æ·»åŠ  effectFn.deps å±æ€§ï¼Œè¯¥å±æ€§ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œç”¨æ¥å­˜æ”¾æ‰€æœ‰åŒ…å«å½“å‰å‰¯ä½œç”¨å‡½æ•°æ‰€æœ‰çš„ä¾èµ–

```js
// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜æ”¾è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
let activeEffect;
// effect ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
function effect(fn) {
  const effectFn = () => {
    // ä¿å­˜å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectFn;

    fn();
  };

  effectFn.deps = [];

  effectFn();
}
```

åœ¨ track ä¸­æ”¶é›†ä¾èµ–

```js
// åœ¨ get å†…éƒ¨è·Ÿè¸ªå˜åŒ–
function track(target, key) {
  if (!activeEffect) return;

  // æ ¹æ® target ä»â€œæ¡¶â€ä¸­å–çš„ depsMapï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ª Map ç±»å‹ï¼š key -> effects
  let depsMap = bucket.get(target);
  if (!depsMap) {
    bucket.set(target, (depsMap = new Map()));
  }

  // å†æ ¹æ® key ä» depsMap ä¸­å–å¾— depsï¼Œå®ƒæ˜¯ä¸€ä¸ª Set ç±»å‹
  let deps = depsMap.get(key);
  if (!deps) {
    depsMap.set(key, (deps = new Set()));
  }

  // æœ€åå°†å½“å‰æ¿€æ´»çš„å‡½æ•°æ·»åŠ åˆ°â€œæ¡¶â€ä¸­
  deps.add(activeEffect);

  // å°†å…¶æ·»åŠ åˆ° activeEffect.deps æ•°ç»„ä¸­
  activeEffect.deps.push(deps);
}
```

æœ€ååœ¨æ¯æ¬¡å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œæ ¹æ® effectFn.deps è·å–æ‰€æœ‰ç›¸å…³è”ä¾èµ–é›†åˆï¼Œè¿›è€Œå°†å‰¯ä½œç”¨å‡½æ•°ä»ä¾èµ–é›†åˆä¸­ç§»é™¤

```js
// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜æ”¾è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
let activeEffect;
// effect ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
function effect(fn) {
  const effectFn = () => {
    cleanup(effectFn);
    // ä¿å­˜å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effecteffectFnFn;

    fn();
  };

  effectFn.deps = [];

  effectFn();
}

function cleanup(effectFn) {
  for (let i = 0; i < effectFn.deps.length; i++) {
    const deps = effectFn.deps[i];
    deps.delete(effectFn);
  }

  effectFn.deps.length = 0;
}
```

ç°åœ¨æ‰§è¡Œä»£ç ï¼Œä½ ä¼šå‘ç°æ­»å¾ªç¯äº†ï¼ŒåŸå› å‡ºåœ¨è¿™ä¸€å¥ä¸Šé¢ï¼š

```js
effects && effects.forEach(fn => fn());
```

> åœ¨è°ƒç”¨ forEach éå† Set é›†åˆæ—¶ï¼Œå¦‚æœä¸€ä¸ªå€¼å·²ç»è¢«è®¿é—®è¿‡äº†ï¼Œä½†æ”¹å€¼è¢«åˆ é™¤å¹¶é‡æ–°æ·»åŠ åˆ°é›†åˆï¼Œå¦‚æœæ­¤æ—¶ forEach éå†æ²¡æœ‰ç»“æŸï¼Œé‚£ä¹ˆæ”¹å€¼ä¼šé‡æ–°è¢«è®¿é—®ã€‚

å®Œæ•´ä»£ç ï¼š

```js
// å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶
const bucket = new WeakMap();

// åŸå§‹æ•°æ®
const data = { ok: true, text: 'hello world' };
// å¯¹åŸå§‹æ•°æ®çš„ä»£ç†
const obj = new Proxy(data, {
  // æ‹¦æˆªè¯»å–æ“ä½œ
  get(target, key) {
    // å°†å‰¯ä½œç”¨å‡½æ•° activeEffect æ·»åŠ åˆ°å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°çš„æ¡¶ä¸­
    track(target, key);
    // è¿”å›å±æ€§å€¼
    return target[key];
  },
  // æ‹¦æˆªè®¾ç½®æ“ä½œ
  set(target, key, newVal) {
    // è®¾ç½®å±æ€§å€¼
    target[key] = newVal;
    // æŠŠå‰¯ä½œç”¨å‡½æ•°ä»æ¡¶é‡Œå–å‡ºå¹¶æ‰§è¡Œ
    trigger(target, key);
  }
});

// åœ¨ get å†…éƒ¨è·Ÿè¸ªå˜åŒ–
function track(target, key) {
  if (!activeEffect) return;

  // æ ¹æ® target ä»â€œæ¡¶â€ä¸­å–çš„ depsMapï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ª Map ç±»å‹ï¼š key -> effects
  let depsMap = bucket.get(target);
  if (!depsMap) {
    bucket.set(target, (depsMap = new Map()));
  }

  // å†æ ¹æ® key ä» depsMap ä¸­å–å¾— depsï¼Œå®ƒæ˜¯ä¸€ä¸ª Set ç±»å‹
  let deps = depsMap.get(key);
  if (!deps) {
    depsMap.set(key, (deps = new Set()));
  }

  // æœ€åå°†å½“å‰æ¿€æ´»çš„å‡½æ•°æ·»åŠ åˆ°â€œæ¡¶â€ä¸­
  deps.add(activeEffect);

  // å°†å…¶æ·»åŠ åˆ° activeEffect.deps æ•°ç»„ä¸­
  activeEffect.deps.push(deps);
}

// åœ¨ set å†…éƒ¨è§¦å‘å˜åŒ–
function trigger(target, key) {
  const depsMap = bucket.get(target);
  if (!depsMap) return;

  const effects = depsMap.get(key);

  const effectsToRun = new Set(effects);
  // effects && effects.forEach(fn => fn());
  effects && effectsToRun.forEach(fn => fn());
}

// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜æ”¾è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
let activeEffect;
// effect ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
function effect(fn) {
  const effectFn = () => {
    cleanup(effectFn);
    // ä¿å­˜å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectFn;

    fn();
  };

  effectFn.deps = [];

  effectFn();
}

function cleanup(effectFn) {
  for (let i = 0; i < effectFn.deps.length; i++) {
    const deps = effectFn.deps[i];
    deps.delete(effectFn);
  }

  effectFn.deps.length = 0;
}

effect(() => {
  console.log('effect run');
  document.body.innerText = obj.ok ? obj.text : 'not';
});

setTimeout(() => {
  obj.ok = false;
  setTimeout(() => {
    obj.text = 'hello vue3';
  }, 1000);
}, 1000);
```

### 5. åµŒå¥—çš„ effect ä¸ effect æ ˆ

effect æ˜¯å¯èƒ½å­˜åœ¨åµŒå¥—å…³ç³»çš„ï¼Œä½†æˆ‘ä»¬ç°åœ¨çš„ä»£ç æ˜¯ä¸èƒ½å®ç°è¿™ä¸ªåŠŸèƒ½çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨ activeEffect æ¥å­˜å‚¨é€šè¿‡ effect å‡½æ•°æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°ï¼Œè¿™å°±æ„å‘³ç€åŒä¸€æ—¶åˆ»åªèƒ½å­˜å‚¨ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°
ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª effectStack å‰¯ä½œç”¨å‡½æ•°æ ˆæ¥é…åˆ

```js
// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜æ”¾è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
let activeEffect;
// å‰¯ä½œç”¨å‡½æ•°æ ˆ
const effectStack = [];
// effect ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
function effect(fn) {
  const effectFn = () => {
    cleanup(effectFn);
    // ä¿å­˜å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectFn;
    // å…¥æ ˆ
    effectStack.push(effectFn);
    fn();
    // å½“å‰å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å¼¹å‡ºæ ˆï¼Œå¹¶æŠŠ activeEffect å¤åŸå›ä¹‹å‰çš„å€¼
    effectStack.pop();
    activeEffect = effectStack[effectStack.length - 1];
  };

  effectFn.deps = [];
  effectFn();
}
```

### 6. é¿å…æ— é™é€’å½’å¾ªç¯

å½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹ä»£ç æ—¶ï¼Œä¼šå‡ºç°æ ˆæº¢å‡º

```js
effect(function effectFn1() {
  console.log('effectFn1 æ‰§è¡Œ');
  obj.foo++;
});
```

æŠŠ obj.foo åˆ†å¼€æ¥çœ‹ï¼Œç›¸å½“äºï¼š

```js
obj.foo = obj.foo + 1;
```

æ—¢ä¼šè¯»å–ï¼Œåˆä¼šè®¾ç½®ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ— é™é€’å½’åœ°è°ƒç”¨è‡ªå·±ï¼Œäºæ˜¯äº§å‡ºæ ˆæº¢å‡º

è§£å†³åŠæ³•ï¼šå¦‚æœ trigger è§¦å‘æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ä¸å½“å‰æ­£åœ¨åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ç›¸åŒï¼Œåˆ™ä¸è§¦å‘æ‰§è¡Œï¼Œå¦‚ä¸€ä¸‹ä»£ç 

```js
// åœ¨ set å†…éƒ¨è§¦å‘å˜åŒ–
function trigger(target, key) {
  const depsMap = bucket.get(target);
  if (!depsMap) return;

  const effects = depsMap.get(key);

  const effectsToRun = new Set();

  effects.forEach(effectFn => {
    if (effectFn !== activeEffect) {
      effectsToRun.add(effectFn);
    }
  });
  effectsToRun.size && effectsToRun.forEach(fn => fn());
}
```

### 7. è°ƒåº¦æ‰§è¡Œ

å¯è°ƒåº¦æ‰§è¡ŒæŒ‡çš„æ˜¯å½“ trigger åŠ¨ä½œè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œæ—¶ï¼Œæœ‰èƒ½åŠ›å†³å®šå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œçš„æ—¶æœºï¼Œæ¬¡æ•°ä»¥åŠæ–¹å¼

æˆ‘ä»¬å¯ä»¥ä¸º effect å‡½æ•°è®¾è®¡ä¸€ä¸ªå¯é€‰å‚æ•° optionsï¼Œå…è®¸ç”¨æˆ·æŒ‡å®šè°ƒåº¦å™¨ï¼š

```js
// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜æ”¾è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
let activeEffect;
// å‰¯ä½œç”¨å‡½æ•°æ ˆ
const effectStack = [];
// effect ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
function effect(fn, options = {}) {
  const effectFn = () => {
    cleanup(effectFn);
    // ä¿å­˜å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectFn;
    // å…¥æ ˆ
    effectStack.push(effectFn);
    fn();
    // å½“å‰å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å¼¹å‡ºæ ˆï¼Œå¹¶æŠŠ activeEffect å¤åŸå›ä¹‹å‰çš„å€¼
    effectStack.pop();
    activeEffect = effectStack[effectStack.length - 1];
  };
  effectFn.options = options;
  effectFn.deps = [];
  effectFn();
}

// é˜²æŠ–
const jobQueue = new Set();
const p = Promise.resolve();

let isFlushing = false;
function flushJob() {
  if (isFlushing) return;
  isFlushing = true;

  p.then(() => {
    jobQueue.forEach(job => job());
  }).finally(() => {
    isFlushing = false;
  });
}

effect(
  () => {
    console.log(obj.foo);
  },
  {
    scheduler(fn) {
      jobQueue.add(fn);
      flushJob();
    }
  }
);
```

ç„¶ååœ¨ trigger å‡½æ•°ä¸­è§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œå°±å¯ä»¥ç›´æ¥è°ƒç”¨ç”¨æˆ·ä¼ é€’çš„è°ƒåº¦å™¨å‡½æ•°ï¼Œä»è€ŒæŠŠæ§åˆ¶æƒäº¤ç»™ç”¨æˆ·ï¼š

```js
// åœ¨ set å†…éƒ¨è§¦å‘å˜åŒ–
function trigger(target, key) {
  const depsMap = bucket.get(target);
  if (!depsMap) return;

  const effects = depsMap.get(key);

  const effectsToRun = new Set();

  effects.forEach(effectFn => {
    if (effectFn !== activeEffect) {
      effectsToRun.add(effectFn);
    }
  });

  effectsToRun.forEach(effectFn => {
    if (effectFn.options.scheduler) {
      effectFn.options.scheduler(effectFn);
    } else {
      effectFn();
    }
  });
}
```

### 8. è®¡ç®—å±æ€§ computed ä¸ lazy

åœ¨æ·±å…¥è®¡ç®—å±æ€§ä¹‹å‰ï¼Œéœ€è¦äº†è§£ä¸€ä¸‹ æ‡’æ‰§è¡Œ lazyï¼Œæˆ‘ä»¬ç°åœ¨æ‰€å®ç°çš„ effect å‡½æ•°ä¼šç«‹å³æ‰§è¡Œæˆ‘ä»¬æ‰€ä¼ é€’çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œä½†åœ¨æœ‰äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å®ƒç«‹å³æ‰§è¡Œï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ options ä¸­æ·»åŠ  lazy å±æ€§æ¥è¾¾åˆ°ç›®çš„:

```js
// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡å­˜æ”¾è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
let activeEffect;
// å‰¯ä½œç”¨å‡½æ•°æ ˆ
const effectStack = [];
// effect ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
function effect(fn, options = {}) {
  const effectFn = () => {
    cleanup(effectFn);
    // ä¿å­˜å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectFn;
    // å…¥æ ˆ
    effectStack.push(effectFn);
    fn();
    // å½“å‰å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å¼¹å‡ºæ ˆï¼Œå¹¶æŠŠ activeEffect å¤åŸå›ä¹‹å‰çš„å€¼
    effectStack.pop();
    activeEffect = effectStack[effectStack.length - 1];
  };

  effectFn.options = options;
  effectFn.deps = [];
  // æ·»åŠ åˆ¤æ–­
  if (!options.lazy) {
    effectFn();
  }
  // è¿”å›å‡½æ•°
  return effectFn;
}

let effectFn = effect(
  () => {
    console.log(obj.foo);
  },
  {
    lazy: true, // æ–°å¢
    scheduler(fn) {
      jobQueue.add(fn);
      flushJob();
    }
  }
);

effectFn();
```

ç°åœ¨æ˜¯æ‰‹åŠ¨æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œæ„ä¹‰ä¸å¤§ï¼Œä½†å¦‚æœæˆ‘ä»¬æŠŠä¼ é€’ç»™ effect çš„å‡½æ•°ä½œä¸ºä¸€ä¸ª getterï¼Œé‚£ä¹ˆè¿™ä¸ª getter å‡½æ•°å¯ä»¥è¿”å›ä»»æ„å€¼

```js
function effect(fn, options = {}) {
  const effectFn = () => {
    cleanup(effectFn);
    // ä¿å­˜å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectFn;
    // å…¥æ ˆ
    effectStack.push(effectFn);

    const res = fn(); // æ–°å¢
    // å½“å‰å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°å¼¹å‡ºæ ˆï¼Œå¹¶æŠŠ activeEffect å¤åŸå›ä¹‹å‰çš„å€¼
    effectStack.pop();
    activeEffect = effectStack[effectStack.length - 1];

    return res; // æ–°å¢;
  };

  effectFn.options = options;
  effectFn.deps = [];
  if (!options.lazy) {
    effectFn();
  }

  return effectFn;
}
```

æ¥ä¸‹æ¥å®ç°ä¸€ä¸ª computed å‡½æ•°

```js
function computed(getter) {
  let value;
  let dirty = true;

  const effectFn = effect(getter, {
    lazy: true,
    scheduler() {
      if (!dirty) {
        dirty = true;
        trigger(obj, 'value');
      }
    }
  });

  const obj = {
    get value() {
      if (dirty) {
        value = effectFn();
        dirty = false;
      }
      track(obj, 'value');
      return value;
    }
  };

  return obj;
}
```

### 9. watch åŸç†

watch çš„å®ç°æœ¬è´¨ä¸Šå°±æ˜¯åˆ©ç”¨äº† effect ä»¥åŠ options.scheduler é€‰é¡¹

```js
function watch(source, cd) {
  effect(() => source.foo, {
    scheduler() {
      cd();
    }
  });
}

watch(obj, () => {
  console.log('ğŸš©  -> file: index.html -> line 870 -> ', 'æ•°æ®å‘é€å˜åŒ–');
});

obj.foo++;
```

ä¸Šé¢çš„ä»£ç å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬ watch ä¸­ä½¿ç”¨äº†ç¡¬ç¼–ç  source.fooï¼Œéœ€è¦å°è£…ä¸€ä¸ªé€šç”¨çš„è¯»å–æ“ä½œï¼š

```js
function traverse(value, seen = new Set()) {
  if (typeof value !== 'object' || value === null || seen.has(value)) return;

  seen.add(value);

  for (const k in value) {
    // è¯»å–å¯¹è±¡æ¯ä¸€ä¸ªå€¼ï¼Œå¹¶ä¸”é€’å½’è°ƒç”¨
    traverse(value[k], seen);
  }

  return value;
}
```

watch å‡½æ•°é™¤äº†å¯ä»¥ç›‘å¬ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼Œè¿˜å¯ä»¥æ¥å—ä¸€ä¸ª getter å‡½æ•°ï¼Œä¿®æ”¹ä¸€ä¸‹ watch å‡½æ•°

```js
function watch(source, cd) {
  let getter;

  if (typeof source === 'function') {
    getter = source;
  } else {
    getter = () => traverse(source);
  }

  effect(() => getter(), {
    scheduler() {
      cd();
    }
  });
}
```

æˆ‘ä»¬è¿˜éœ€è¦è·å–æ–°å€¼ä¸æ—§å€¼ï¼Œè¿™éœ€è¦å……åˆ†åˆ©ç”¨åˆ° effect å’Œ laze é€‰é¡¹

```js
function watch(source, cd) {
  let getter;

  if (typeof source === 'function') {
    getter = source;
  } else {
    getter = () => traverse(source);
  }

  let oldValue, newValue;

  const effectFn = effect(() => getter(), {
    lazy: true,
    scheduler() {
      newValue = effectFn();
      cd(oldValue, newValue);
      oldValue = newValue;
    }
  });

  oldValue = effectFn();
}

watch(
  () => obj.foo,
  (oldValue, newValue) => {}
);

obj.foo++;
```

### 10. ç«‹åˆ»æ‰§è¡Œçš„ watch ä¸å›è°ƒæ‰§è¡Œæ—¶æœº

```js
function watch(source, cd, options = {}) {
  let getter;

  if (typeof source === 'function') {
    getter = source;
  } else {
    getter = () => traverse(source);
  }

  let oldValue, newValue;

  const job = () => {
    newValue = effectFn();
    cd(oldValue, newValue);
    oldValue = newValue;
  };

  const effectFn = effect(() => getter(), {
    lazy: true,
    scheduler: () => {
      if (options.flush === 'post') {
        const p = Promise.resolve();
        p.then(job);
      } else {
        job();
      }
    }
  });

  if (options.immediate) {
    job();
  } else {
    oldValue = effectFn();
  }
}
```

### 11. è¿‡æœŸå‰¯ä½œç”¨

```js
function watch(source, cb, options = {}) {
  let getter;
  if (typeof source === 'function') {
    getter = source;
  } else {
    getter = () => traverse(source);
  }

  let oldValue, newValue;

  let cleanup;
  function onInvalidate(fn) {
    cleanup = fn;
  }

  const job = () => {
    newValue = effectFn();
    if (cleanup) {
      cleanup();
    }
    cb(oldValue, newValue, onInvalidate);
    oldValue = newValue;
  };

  const effectFn = effect(
    // æ‰§è¡Œ getter
    () => getter(),
    {
      lazy: true,
      scheduler: () => {
        if (options.flush === 'post') {
          const p = Promise.resolve();
          p.then(job);
        } else {
          job();
        }
      }
    }
  );

  if (options.immediate) {
    job();
  } else {
    oldValue = effectFn();
  }
}
```
