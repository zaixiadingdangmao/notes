- [å‘å¸ƒ-è®¢é˜…æ¨¡å¼](#å‘å¸ƒ-è®¢é˜…æ¨¡å¼)
  - [1. DOM äº‹ä»¶](#1-dom-äº‹ä»¶)
  - [2. è‡ªå®šä¹‰äº‹ä»¶](#2-è‡ªå®šä¹‰äº‹ä»¶)
  - [3. å–æ¶ˆè®¢é˜…çš„äº‹ä»¶](#3-å–æ¶ˆè®¢é˜…çš„äº‹ä»¶)
  - [4. çœŸå®çš„ä¾‹å­â€”â€”ç½‘ç«™ç™»å½•](#4-çœŸå®çš„ä¾‹å­ç½‘ç«™ç™»å½•)

## å‘å¸ƒ-è®¢é˜…æ¨¡å¼

å‘å¸ƒâ€”è®¢é˜…æ¨¡å¼åˆå«è§‚å¯Ÿè€…æ¨¡å¼ï¼Œå®ƒå®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å°†å¾—åˆ°é€šçŸ¥ã€‚åœ¨ JavaScript å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç”¨äº‹ä»¶æ¨¡å‹æ¥æ›¿ä»£ä¼ ç»Ÿçš„å‘å¸ƒâ€”è®¢é˜…æ¨¡å¼

### 1. DOM äº‹ä»¶

è¿™é‡Œéœ€è¦ç›‘æ§ç”¨æˆ·ç‚¹å‡» document.body çš„åŠ¨ä½œï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡åŠæ³•é¢„çŸ¥ç”¨æˆ·å°†åœ¨ä»€ä¹ˆæ—¶å€™ç‚¹å‡»ã€‚æ‰€ä»¥æˆ‘ä»¬è®¢é˜… document.body ä¸Šçš„ click äº‹ä»¶ï¼Œå½“ body èŠ‚ç‚¹è¢«ç‚¹å‡»æ—¶ï¼Œbody èŠ‚ç‚¹ä¾¿ä¼šå‘è®¢é˜…è€…å‘å¸ƒè¿™ä¸ªæ¶ˆæ¯ã€‚è¿™å¾ˆåƒè´­æˆ¿çš„ä¾‹å­ï¼Œè´­æˆ¿è€…ä¸çŸ¥é“æˆ¿å­ä»€ä¹ˆæ—¶å€™å¼€å”®ï¼Œäºæ˜¯ä»–åœ¨è®¢é˜…æ¶ˆæ¯åç­‰
å¾…å”®æ¥¼å¤„å‘å¸ƒæ¶ˆæ¯

```js
document.body.addEventListener(
  'click',
  function () {
    alert(2);
  },
  false
);

document.body.click(); // æ¨¡æ‹Ÿç”¨æˆ·ç‚¹å‡»
```

å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥éšæ„å¢åŠ æˆ–è€…åˆ é™¤è®¢é˜…è€…ï¼Œå¢åŠ ä»»ä½•è®¢é˜…è€…éƒ½ä¸ä¼šå½±å“å‘å¸ƒè€…ä»£ç çš„ç¼–å†™ï¼š

```js
document.body.addEventListener(
  'click',
  function () {
    alert(2);
  },
  false
);

document.body.addEventListener(
  'click',
  function () {
    alert(3);
  },
  false
);

document.body.addEventListener(
  'click',
  function () {
    alert(4);
  },
  false
);

document.body.click(); // æ¨¡æ‹Ÿç”¨æˆ·ç‚¹å‡»
```

### 2. è‡ªå®šä¹‰äº‹ä»¶

è®©è®¢é˜…è€…åªè®¢é˜…è‡ªå·±æ„Ÿå…´è¶£çš„æ¶ˆæ¯

```js
var salesOffices = {}; // å®šä¹‰å”®æ¥¼å¤„

salesOffices.clientList = {}; // ç¼“å­˜åˆ—è¡¨ï¼Œå­˜æ”¾è®¢é˜…è€…çš„å›è°ƒå‡½æ•°

salesOffices.listen = function (key, fn) {
  if (!this.clientList[key]) {
    // å¦‚æœè¿˜æ²¡æœ‰è®¢é˜…è¿‡æ­¤ç±»æ¶ˆæ¯ï¼Œç»™è¯¥ç±»æ¶ˆæ¯åˆ›å»ºä¸€ä¸ªç¼“å­˜åˆ—è¡¨
    this.clientList[key] = [];
  }
  this.clientList[key].push(fn); // è®¢é˜…çš„æ¶ˆæ¯æ·»åŠ è¿›æ¶ˆæ¯ç¼“å­˜åˆ—è¡¨
};

salesOffices.trigger = function () {
  // å‘å¸ƒæ¶ˆæ¯
  var key = Array.prototype.shift.call(arguments), // å–å‡ºæ¶ˆæ¯ç±»å‹
    fns = this.clientList[key]; // å–å‡ºè¯¥æ¶ˆæ¯å¯¹åº”çš„å›è°ƒå‡½æ•°é›†åˆ

  if (!fns || fns.length === 0) {
    // å¦‚æœæ²¡æœ‰è®¢é˜…è¯¥æ¶ˆæ¯ï¼Œåˆ™è¿”å›
    return false;
  }

  for (var i = 0, fn; (fn = fns[i++]); ) {
    fn.apply(this, arguments); // (2) // arguments æ˜¯å‘å¸ƒæ¶ˆæ¯æ—¶é™„é€çš„å‚æ•°
  }
};

salesOffices.listen('squareMeter88', function (price) {
  // å°æ˜è®¢é˜…88 å¹³æ–¹ç±³æˆ¿å­çš„æ¶ˆæ¯
  console.log('ä»·æ ¼= ' + price); // è¾“å‡ºï¼š 2000000
});

salesOffices.listen('squareMeter110', function (price) {
  // å°çº¢è®¢é˜…110 å¹³æ–¹ç±³æˆ¿å­çš„æ¶ˆæ¯
  console.log('ä»·æ ¼= ' + price); // è¾“å‡ºï¼š 3000000
});

salesOffices.trigger('squareMeter88', 2000000); // å‘å¸ƒ88 å¹³æ–¹ç±³æˆ¿å­çš„ä»·æ ¼
salesOffices.trigger('squareMeter110', 3000000); // å‘å¸ƒ110 å¹³æ–¹ç±³æˆ¿å­çš„ä»·æ ¼
```

### 3. å–æ¶ˆè®¢é˜…çš„äº‹ä»¶

```js
event.remove = function (key, fn) {
  var fns = this.clientList[key];

  if (!fns) {
    // å¦‚æœkey å¯¹åº”çš„æ¶ˆæ¯æ²¡æœ‰è¢«äººè®¢é˜…ï¼Œåˆ™ç›´æ¥è¿”å›
    return false;
  }

  if (!fn) {
    // å¦‚æœæ²¡æœ‰ä¼ å…¥å…·ä½“çš„å›è°ƒå‡½æ•°ï¼Œè¡¨ç¤ºéœ€è¦å–æ¶ˆkey å¯¹åº”æ¶ˆæ¯çš„æ‰€æœ‰è®¢é˜…
    fns && (fns.length = 0);
  } else {
    for (var l = fns.length - 1; l >= 0; l--) {
      // åå‘éå†è®¢é˜…çš„å›è°ƒå‡½æ•°åˆ—è¡¨
      var _fn = fns[l];
      if (_fn === fn) {
        fns.splice(l, 1); // åˆ é™¤è®¢é˜…è€…çš„å›è°ƒå‡½æ•°
      }
    }
  }
};
```

### 4. çœŸå®çš„ä¾‹å­â€”â€”ç½‘ç«™ç™»å½•

å‡å¦‚æˆ‘ä»¬æ­£åœ¨å¼€å‘ä¸€ä¸ªå•†åŸç½‘ç«™ï¼Œç½‘ç«™é‡Œæœ‰ header å¤´éƒ¨ã€nav å¯¼èˆªã€æ¶ˆæ¯åˆ—è¡¨ã€è´­ç‰©è½¦ç­‰æ¨¡å—ã€‚è¿™å‡ ä¸ªæ¨¡å—çš„æ¸²æŸ“æœ‰ä¸€ä¸ªå…±åŒçš„å‰ææ¡ä»¶ï¼Œå°±æ˜¯å¿…é¡»å…ˆç”¨ ajax å¼‚æ­¥è¯·æ±‚è·å–ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ã€‚è¿™æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œæ¯”å¦‚ç”¨æˆ·çš„åå­—å’Œå¤´åƒè¦æ˜¾ç¤ºåœ¨ header æ¨¡å—é‡Œï¼Œè€Œè¿™ä¸¤ä¸ªå­—æ®µéƒ½æ¥è‡ªç”¨æˆ·ç™»å½•åè¿”å›çš„ä¿¡æ¯ã€‚

æ™®é€šå†™æ³•ï¼Œç­‰å¾… ajax æˆåŠŸä»¥åæŒ¨ä¸ªè°ƒç”¨ï¼š

```js
login.succ(function (data) {
  header.setAvatar(data.avatar); // è®¾ç½®header æ¨¡å—çš„å¤´åƒ
  nav.setAvatar(data.avatar); // è®¾ç½®å¯¼èˆªæ¨¡å—çš„å¤´åƒ
  message.refresh(); // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
  cart.refresh(); // åˆ·æ–°è´­ç‰©è½¦åˆ—è¡¨
});
```

å¦‚æœåæœŸéœ€è¦æ–°å¢ä¸€ä¸ªå…¶ä»–æ–¹æ³•ï¼Œåªèƒ½åœ¨æœ€åéƒ¨åˆ†åŠ ä¸Šè¿™è¡Œä»£ç ï¼š

```js
login.succ(function (data) {
  header.setAvatar(data.avatar);
  nav.setAvatar(data.avatar);
  message.refresh();
  cart.refresh();
  address.refresh(); // å¢åŠ è¿™è¡Œä»£ç 
});
```

ç”¨å‘å¸ƒâ€”è®¢é˜…æ¨¡å¼é‡å†™ä¹‹åï¼Œå¯¹ç”¨æˆ·ä¿¡æ¯æ„Ÿå…´è¶£çš„ä¸šåŠ¡æ¨¡å—å°†è‡ªè¡Œè®¢é˜…ç™»å½•æˆåŠŸçš„æ¶ˆæ¯äº‹ä»¶:

```js
$.ajax('http:// xxx.com?login', function (data) {
  // ç™»å½•æˆåŠŸ
  login.trigger('loginSucc', data); // å‘å¸ƒç™»å½•æˆåŠŸçš„æ¶ˆæ¯
});
```

å„æ¨¡å—ç›‘å¬ç™»å½•æˆåŠŸçš„æ¶ˆæ¯ï¼š

```js
var header = (function () {
  // header æ¨¡å—
  login.listen('loginSucc', function (data) {
    header.setAvatar(data.avatar);
  });
  return {
    setAvatar: function (data) {
      console.log('è®¾ç½®header æ¨¡å—çš„å¤´åƒ');
    }
  };
})();

var nav = (function () {
  // nav æ¨¡å—
  login.listen('loginSucc', function (data) {
    nav.setAvatar(data.avatar);
  });
  return {
    setAvatar: function (avatar) {
      console.log('è®¾ç½®nav æ¨¡å—çš„å¤´åƒ');
    }
  };
})();
```

å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬éšæ—¶å¯ä»¥æŠŠ setAvatar çš„æ–¹æ³•åæ”¹æˆ setTouxiangã€‚å¦‚æœæœ‰ä¸€å¤©åœ¨ç™»å½•å®Œæˆä¹‹åï¼Œåˆå¢åŠ ä¸€ä¸ªåˆ·æ–°æ”¶è´§åœ°å€åˆ—è¡¨çš„è¡Œä¸ºï¼Œé‚£ä¹ˆåªè¦åœ¨æ”¶è´§åœ°å€æ¨¡å—é‡ŒåŠ ä¸Šç›‘å¬æ¶ˆæ¯çš„æ–¹æ³•å³å¯ï¼Œè€Œè¿™å¯ä»¥è®©å¼€å‘è¯¥æ¨¡å—çš„åŒäº‹è‡ªå·±å®Œæˆï¼Œä½ ä½œä¸ºç™»å½•æ¨¡å—çš„å¼€å‘è€…ï¼Œæ°¸è¿œä¸ç”¨å†å…³å¿ƒè¿™äº›è¡Œä¸ºäº†ã€‚ä»£ç å¦‚ä¸‹ï¼š

```js
var address = (function () {
  // nav æ¨¡å—
  login.listen('loginSucc', function (obj) {
    address.refresh(obj);
  });
  return {
    refresh: function (avatar) {
      console.log('åˆ·æ–°æ”¶è´§åœ°å€åˆ—è¡¨');
    }
  };
})();
```

å®ç°ï¼š

```js
function Login() {
  this.clientList = {};
  this.offlineClientList = {};
}

Login.prototype.trigger = function () {
  const key = Array.prototype.shift.call(arguments); // (1);
  const fns = this.clientList[key];

  if (!fns || fns.length === 0) {
    this.offlineClientList[key] = arguments;
    return false;
  }

  for (let i = 0; i < fns.length; i++) {
    const fn = fns[i];
    fn.apply(this, arguments);
  }
};

Login.prototype.listen = function (key, fn) {
  if (!this.clientList[key]) {
    this.clientList[key] = [];
  }

  this.clientList[key].push(fn);

  if (this.offlineClientList[key]) {
    for (let i = 0; i < this.offlineClientList[key].length; i++) {
      const arg = this.offlineClientList[key];
      fn.apply(this, arg);
    }
    delete this.offlineClientList[key];
  }
};

const login = new Login();

login.trigger('succ', 'zxl');

login.listen('succ', value => {
  console.log('ğŸš€  -> file: index.html:142 -> value', value);
  console.log('ğŸš©  -> file: index.html -> line 93 -> ', '1');
});

login.listen('succ', value => {
  console.log('ğŸš€  -> file: index.html:147 -> value', value);
  console.log('ğŸš©  -> file: index.html -> line 93 -> ', '2');
});

login.trigger('succ', 'å°å¸…å“¥');

console.log('ğŸš©  -> file: index.html -> line 149 -> ', login);
```
